#!/usr/bin/env bash

set -o nounset
set -o errexit
set -o pipefail

SRC="$(readlink "${BASH_SOURCE[0]}" || realpath "${BASH_SOURCE[0]}")"
DIR="$(cd "$(dirname "$SRC")/.." && pwd -P)"

cd "$DIR"

source ./lib/utils.bash

# usage() {
#   local ret="$?"
#   if [[ $# -ne 0 ]]
#   then ret="$1"; shift
#   fi
#   if [[ $# -ne 0 ]]
#   then err "$@"
#   fi
#   usage_exit "$ret" "Usage: ${0##*/} [install|remove] $OPTS"
# }

# sync_upstream() {
#   local url="$1"
#   local prefix="${1%.git}"
#   local branch="${2:-master}"
#   prefix="${prefix##*/}"
#   if [[ ! -d "$DIR/$prefix" ]]
#   then run git subtree add --prefix "$prefix" "$url" "$branch" --squash
#   fi
# }

subtree_do() {
  local action="$1"
  local url="$2"
  local prefix="$3"
  local branch="${4:-master}"

  git subtree $action --prefix "$prefix" "$url" "$branch" --squash

  log "Done [$?]"
}

main() {
  local action="$1"
  local path="${2:-git@github.com:$USER/dot-}"
  local dir="$3"
  # git log | awk '/git-subtree-dir/ { print $2 }'

  case "$action" in
    add) subtree_do $action "$path" "$dir" ;;
    pull|push)
      local base="src"
      local dot t
      for dot in $DIR/$base/*
      do d="$(basename "$dot")"
        subtree_do $action "$path$d.git" "$base/$d" # "master"
      done
      ;;
    *) err "$action: unknown action" ;;
  esac
}

main "$@"
