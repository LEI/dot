version: "2"

services:

  build:
    build:
      context: .
      dockerfile: docker/golang.Dockerfile # alpine
    image: lei/dot
    container_name: dot
    # entrypoint: /bin/bash
    command: -l # -c 'exec bash -l'
    environment:
      GIT_AUTHOR_NAME: Docker
      GIT_AUTHOR_EMAIL: do@ck.er

  test:
    image: lei/dot # _test
    depends_on:
      - build
    container_name: dot_test
    command: -l -c 'scripts/e2e-test.sh'

  test_os:
    build:
      context: .
      dockerfile: docker/$OS.Dockerfile
    # image: lei/dot_$OS
    container_name: dot_$OS
    command: -l -c '/tmp/scripts/e2e-test.sh'

  test_android:
    build:
      context: .
      dockerfile: docker/termux.Dockerfile
    container_name: dot_android
    command: -l -c '/tmp/scripts/e2e-test.sh'
    # libguestfs
    privileged: true
    # cap_add:
    #   - MKNOD
    #   - SYS_ADMIN
    # devices:
    #   - /dev/fuse
    # # gcc -fPIC -shared  -o docker/wrap_uname.so docker/wrap_uname.c -ldl
    # volumes:
    #   - "./docker/wrap_uname.so:/lib/wrap_uname.so"
    # environment:
    #   LD_PRELOAD: /lib/wrap_uname.so
