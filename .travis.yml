sudo: false

services:
  - docker

language: go

# go:
#   - "1.x"
#   - "1.8"
#   - "1.10.x"
#   - master

os:
  - linux

matrix:
  allow_failures:
    - go: master
  fast_finish: true

cache:
  directories:
    - $GOPATH/bin
    # - $GOPATH/pkg/dep
    # - $GOPATH/src/github.com/LEI/dot/dist
    - $GOPATH/src/github.com/LEI/dot/vendor

stages:
  - build
  - test
  - deploy

before_intall:
  - make mage
  - mage

install: mage snapshot

jobs:
  include:
    # - stage: build
    #   install: skip
    #   before_script: docker-compose build base
    #   script: docker-compose run test
    #   # env: OS=

    - &testos
      stage: test
      # install: true
      script:
        - docker-compose run base
        - docker-compose build test

    - <<: *testos
      before_script:
        - export OS=alpine
      script:
        - docker-compose run test_os
        - docker-compose build test_os
      # env: OS=alpine

    - <<: *testos
      before_script:
        - export OS=archlinux

    - <<: *testos
      before_script:
        - export OS=centos

    - <<: *testos
      before_script:
        - export OS=debian

    - stage: test
      install:
        # - (cd "$(brew --repo)" && git fetch && git reset --hard origin/master && brew update)
        - export HOMEBREW_NO_ANALYTICS=1
        - export HOMEBREW_NO_EMOJI=1
        - brew upgrade --quiet || true
        - brew install --quiet gnu-sed --with-default-names
        - if test ! -d $GOPATH/bin; then mkdir $GOPATH/bin; fi
        - mage && mage snapshot
      before_script: cp dist/darwin_amd64/dot /usr/local/bin/dot
      # TODO script: scripts/e2e-test.sh
      env: OS=darwin
      os: osx
      language: go

    # - stage: deploy
    #   addons:
    #     apt:
    #       packages:
    #       - rpm
    #       - snapd
    #   env:
    #     - PATH=/snap/bin:$PATH
    #   before_deploy:
    #     - sudo snap install snapcraft --classic
    #   deploy:
    #     provider: script
    #     script: echo curl -sL https://git.io/goreleaser # | bash # scripts/release.sh
    #     skip_cleanup: true
    #     on:
    #       repo: LEI/dot
    #       tags: true
    #       condition: $TRAVIS_OS_NAME = linux

notifications:
  email: false
