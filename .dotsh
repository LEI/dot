#!/usr/bin/env bash

git_config() {
  local state="$1"
  local file="$2"
  local key="$3"
  case "$state" in
    install)
      if [[ -z "$(git config --file "$file" --get "$key")" ]]
      then local msg var default reply
        # printf "%s" "What is your git ${key#user.}? "; read -r reply
        msg="What is your git ${key#user.}?"
        var="GIT_$(echo "${key//./_}" | tr "[:lower:]" "[:upper:]")"
        default="${!var:-}"
        [[ -n "$default" ]] && msg+=" (${var:-default}: $default)"
        printf "%s" "$msg "
        [[ "${INTERACTIVE:-1}" -ne 0 ]] && read -r reply
        [[ -n "$default" ]] && [[ -z "${reply:-}" ]] && reply="$default"
        printf "\n"
        run git config --file "$file" --add "$key" "$reply"
      fi
      ;;
    remove)
      if [[ -n "$(git config --file "$file" --get "$key")" ]] || confirm "Unset local git ${key#user.}"
      then run git config --file "$file" --unset "$key"
      fi
      ;;
  esac
}

_main() {
  symlink "$state" --path .git*

  local cfg="$HOME/.gitconfig.local"
  local key
  for key in user.{name,username,email}
  do git_config "$state" "$cfg" "$key"
  done

  # Remove ~/.gitconfig.local if empty
  if [[ "$state" == "remove" ]] && [[ -z "$(git config --file "$cfg" --list)" ]]
  then rm "$cfg"
  fi
}

_main "$@"
