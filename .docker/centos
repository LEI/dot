# vi: ft=Dockerfile
FROM centos

ENV OS linux
ENV ARCH amd64
ENV USER docker

# RUN printf "errorlevel=0\nrpmverbosity=critical\n" >> /etc/yum.conf

# yum groupinstall --assumeyes --quiet "Development Tools" && \
# yum install --assumeyes --quiet \
# gettext-devel openssl-devel perl-CPAN perl-devel zlib-devel \
# ca-certificates \
RUN yum update --assumeyes --quiet && \
yum install --assumeyes --quiet \
curl-devel expat-devel gettext-devel openssl-devel zlib-devel \
gcc perl-ExtUtils-MakeMaker \
autoconf make \
sudo
# epel-release

# Install latest git instead of 1.8
ENV GIT_VERSION 2.18.0
ADD https://github.com/git/git/archive/v$GIT_VERSION.tar.gz git.tar.gz
RUN tar -zxf git.tar.gz && \
cd git-$GIT_VERSION && \
make configure && \
./configure --prefix=/usr/local && \
sudo make install

COPY ./dist/${OS}_${ARCH}/dot /usr/local/bin/dot

RUN useradd --create-home --shell /bin/bash $USER
RUN echo "$USER:$USER" | chpasswd
RUN echo '%sudo ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers.d/sudo
RUN groupadd sudo && usermod -aG sudo $USER

# Add /usr/local/bin to PATH while sudoing
RUN sed -i -e 's#Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin#Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin#' /etc/sudoers

# Pre-install pacapt
ADD https://github.com/icy/pacapt/raw/ng/pacapt /usr/local/bin/pacapt
RUN sudo chmod 755 /usr/local/bin/pacapt

USER $USER

WORKDIR /home/$USER

COPY ./scripts scripts
COPY ./.dot.yml .dot.yml

#RUN dot install --packages --sudo

ENTRYPOINT ["/bin/bash"]
